<!DOCTYPE html>
<html>

<head>
    <!--
        References:
        - Code for range slider: https://codepen.io/predragdavidovic/pen/mdpMoWo
    -->
    <title>INFO4310 HW2</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .viz {
            margin: 20px;
        }

        .button-container {
            margin: 10px;
        }

        .title {
            font-size: 36px;
            color: rgb(241, 241, 241);
            font-family: 'Merriweather', serif;
        }

        .text {
            font-size: 16px;
            color: rgb(241, 241, 241);
            font-family: 'Merriweather', serif;
        }

        .label {
            font-size: 12px;
            font-family: 'Merriweather', serif;
        }

        button {
            padding: 10px;
            font-size: 14px;
            margin-right: 10px;
            font-family: 'Merriweather', serif;
            background-color: rgba(214, 214, 231, 0.494);
            stroke-width: 1.5px;
            cursor: pointer;
        }

        .brush .selection {
            fill: rgba(214, 214, 231, 0.539);
            stroke: rgba(255, 255, 255, 0.524);
            stroke-width: 1.5px;
        }

        body {
            background-color: #050030;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            font-family: 'Merriweather', serif;
        }

        .axis{
            color:white;
        }

        /* Range slider & input box */
        .range_container {
            display: flex;
            flex-direction: column;
            width: 200px;
            margin: 20px auto 0px auto;
        }

        .sliders_control {
            position: relative;
            min-height: 15px;
        }

        .form_control {
            position: relative;
            display: flex;
            justify-content: space-between;
            font-size: 18px;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            pointer-events: all;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 1px #C6C6C6;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            background: #fff;
        }

        input[type=range]::-webkit-slider-thumb:active {
            box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
            -webkit-box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
        }

        input[type="number"] {
            width: 45px;
            height: 25px;
            font-size: 16px;
            border: none;
            background-color: #6b7280;
            color: white;
            border-radius: 3px;
            margin-top: 5px;
            font-family: 'Merriweather', serif;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button {  
            opacity: 1;
        }

        input[type="range"] {
            -webkit-appearance: none; 
            appearance: none;
            height: 3.5px;
            width: 100%;
            position: absolute;
            background-color: #C6C6C6;
            pointer-events: none;
        }

        #fromSlider{
            height: 0;
            z-index: 1;
        }

        #fromSlider::-webkit-slider-thumb{
            margin-top: 4px;
        }

        .form_control_container{
            font-size: 14px
        }
        
        .input_max{
            margin-right: -25px
        }
    </style>
</head>

<body>
    <h1 style="font-family: Gill Sans, 'Times New Roman', Times, serif; color:azure; font-size: 40px;">Pick the Perfect
        <span style="color: #ffe608; font-size: 50px;">B</span><span
            style="color: #fa7646; font-size: 50px;">O</span><span style="color:#fec2ff; font-size: 50px;">A</span><span
            style="color:#4ec8fc; font-size: 50px; padding-left: 2px;">R</span><span
            style="color: #c291fa; font-size: 50px; padding-left: 2px">D</span>
        GAME for Tonight's Game Night!
    </h1>
    "Strategy Games": "#4ec8fc",
    "Thematic Games": "#fcc544",
    "Family Games": "#ffe608",
    "Customizable Games": "#c291fa",
    "Abstract Games": "#48e05c",
    "Party Games": "#fa7646",
    "Wargames": "#ba3440",
    "Children's Games": "#fec2ff"
    <div>
        <div class="button-container">
            <button id="zoom-btn">Zoom</button>
            <button id="reset-btn">Reset</button>
        </div>
        <div id="toolbar" width="1200" height="300" style="display: flex; flex-direction: row">
            <div width="500">
                <div class="range_container">
                    <div class="sliders_control">
                       <input id="fromSlider" type="range" value="1" min="1" max="30"/>
                       <input id="toSlider" type="range" value="30" min="1" max="30"/>
                    </div>
                    <div class="form_control">
                      <div class="form_control_container">
                          <div class="form_control_container__time">Min</div>
                          <input class="form_control_container__time__input" type="number" id="fromInput" value="1" min="1" max="30"/>
                        </div>
                        <div class="form_control_container">
                          <div class="form_control_container__time input_max">Max</div>
                          <input class="form_control_container__time__input input_max" type="number" id="toInput" value="30" min="1" max="30"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="viz" style="display: flex; flex-direction: row">
            <svg id="scatter" width="600" height="600"></svg>
            <svg id="bggTable" width="500" height="500"></svg>
        </div>
    </div>

    <script>
        const table = d3.select("#bggTable");
        const tableWidth = table.attr("width");
        const tableHeight = table.attr("height");
        d3.json("./bgg_dataset_cleaned.json").then(function (data) {
            data.forEach((d, i) => {
                d.owned_users = +d.owned_users;
                d.rating_average = +d.rating_average;
                d.index = i;
            });

            let visibleIndices = data.map(d => d.index);

            const width = 600, height = 600, margin = { top: 50, right: 50, bottom: 50, left: 100 };
            const minOwnedUsers = Math.max(1, d3.min(data, d => d.owned_users));
            const maxOwnedUsers = d3.max(data, d => d.owned_users);
            const maxRating = d3.max(data, d => d.rating_average);

            let xScale = d3.scaleLog()
                .domain([minOwnedUsers, maxOwnedUsers])
                .range([margin.left, width - margin.right]);

            let yScale = d3.scaleLinear().domain([0, maxRating]).range([height - margin.bottom, margin.top]);

            const svg = d3.select("#scatter");
            let xAxis = svg.append("g").attr("class","axis").attr("transform", `translate(0,${height - margin.bottom})`).call(d3.axisBottom(xScale).ticks(10, "~s"));
            let yAxis = svg.append("g").attr("class","axis").attr("transform", `translate(${margin.left},0)`).call(d3.axisLeft(yScale));

            svg.append("text")
                .attr("class", "label")
                .attr("text-anchor", "end")
                .attr("x", width / 2 + margin.left)
                .attr("y", height + margin.bottom - 40)
                .attr("fill","white")
                .text("Popularity (Log Scale)");

            svg.append("text")
                .attr("class", "label")
                .attr("text-anchor", "end")
                .attr("x", -height / 2 + margin.top)
                .attr("y", margin.left - 60)
                .attr("dy", ".75em")
                .attr("transform", "rotate(-90)")
                .attr("fill","white")
                .text("Average Rating");

            let uniqueDomains = Array.from(new Set(data.map(d => d.domains1)));
            console.log(uniqueDomains);

            let domainColors = {
                "Strategy Games": "#4ec8fc",
                "Thematic Games": "#fcc544",
                "Family Games": "#ffe608",
                "Customizable Games": "#c291fa",
                "Abstract Games": "#48e05c",
                "Party Games": "#fa7646",
                "Wargames": "#ba3440",
                "Children's Games": "#fec2ff"
            };

            let tableColorScale = d3.scaleOrdinal().domain(Object.keys(domainColors)).range(Object.values(domainColors));

            table.append("circle")
                .attr("class", "default-table")
                .attr("cx", 250)
                .attr("cy", 250)
                .attr("r", 170)
                .attr("fill", "none")
                .attr("stroke-width", 3)
                .attr("stroke", "grey");

            table.append("text")
                .attr("transform", "translate(250, 220)")
                .attr("text-anchor", "middle")
                .attr("font-family", "Gill Sans")
                .attr("font-size", "18px")
                .text(String.fromCodePoint(0x1F50D) + " Hoever a dot on the left to")
                .attr("fill", "white");

            table.append("text")
                .attr("transform", "translate(250, 250)")
                .attr("text-anchor", "middle")
                .attr("font-family", "Gill Sans")
                .attr("font-size", "18px")
                .text("pick a boardgame for details " + String.fromCodePoint(0x1F50D))
                .attr("fill", "white");


            let circles = svg.selectAll("circle")
                .data(data)
                .enter()
                .append("circle")
                .attr("cx", d => xScale(d.owned_users))
                .attr("cy", d => yScale(d.rating_average))
                .attr("r", 2)
                .attr("fill", d => tableColorScale(d.domains1))
                .attr("opacity", 0.7)
                .on("mouseover", function (event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 8)
                        .attr("stroke", "black")
                        .attr("stroke-width", 3)
                        .attr("opacity", 1);

                    let tableColor = tableColorScale(d.domains1);
                    table.append("circle")
                        .attr("class", "hover-table")
                        .attr("cx", 250)
                        .attr("cy", 250)
                        .attr("r", 170)
                        .attr("fill", tableColor)
                        .attr("stroke-width", 3)
                        .attr("stroke", "grey");

                    let textGroup = table.append("g")
                        .attr("class", "table-text")
                        .attr("transform", "translate(250, 230)")
                        .attr("text-anchor", "middle")
                        .attr("font-family", "Gill Sans")
                        .attr("font-size", "12px")

                    const words = d.name.split(/\s+/);
                    const firstPart = words.slice(0, 4).join(' ');
                    const rest = words.slice(4).join(' ');
                    textGroup.append("text")
                        .text(firstPart)
                        .attr("y", -40)
                        .attr("font-weight", "bold");
                    textGroup.append("text")
                        .text(rest)
                        .attr("y", -20)
                        .attr("font-weight", "bold");
                    textGroup.append("text")
                        .text(`Year published: ${d.year_published}`)
                        .attr("y", 0);
                    textGroup.append("text")
                        .text(`Players allowed: ${d.min_players} (Min) - ${d.max_players} (Max)`)
                        .attr("y", 20);
                    textGroup.append("text")
                        .text(`Suggested play time: ${d.play_time} min`)
                        .attr("y", 40);
                    textGroup.append("text")
                        .text(`Game Age Limit: ${d.min_age}+`)
                        .attr("y", 60);
                    textGroup.append("text")
                        .text(`Rating for the game: ${d.rating_average}`)
                        .attr("y", 80);
                    textGroup.append("text")
                        .text(`Game Complexity : ${d.complexity_average}`)
                        .attr("y", 100);
                    textGroup.append("text")
                        .text(`Number of people downloaded : ${d.owned_users}`)
                        .attr("y", 120);

                    let centerX = 250;
                    let centerY = 250;
                    let radius = 170;
                    let maxPlayers = parseInt(d["max_players"], 10)
                    console.log(maxPlayers);

                    for (let i = 0; i < maxPlayers; i++) {
                        let angle = (i / maxPlayers) * 2 * Math.PI;
                        let seatX = centerX + (radius + 40) * Math.cos(angle);
                        let seatY = centerY + (radius + 40) * Math.sin(angle);
                        let rotateDeg = (angle * 180) / Math.PI + 90;

                        let seatSize = maxPlayers > 10 ? 35 : 60;
                        let offset = seatSize / 2;

                        table.append("image")
                            .attr("class", "seat-icon")
                            .attr("xlink:href", "seat_empty.png")
                            .attr("x", seatX - offset)
                            .attr("y", seatY - offset)
                            .attr("width", seatSize)
                            .attr("height", seatSize)
                            .attr("transform", `rotate(${rotateDeg}, ${seatX}, ${seatY})`)
                            .attr("opacity",0.8);
                    }

                    for (let j = 0; j < minPlayers; j++) {
                        let angle = (j / maxPlayers) * 2 * Math.PI;
                        let seatX = centerX + (radius + 40) * Math.cos(angle);
                        let seatY = centerY + (radius + 40) * Math.sin(angle);
                        let rotateDeg = (angle * 180) / Math.PI + 90;

                        let seatSize = maxPlayers > 15 ? 40 : 60;
                        let offset = seatSize / 2;

                        table.append("image")
                            .attr("class", "seat-icon")
                            .attr("xlink:href", "seat_default.png")
                            .attr("x", seatX - offset)
                            .attr("y", seatY - offset)
                            .attr("width", seatSize)
                            .attr("height", seatSize)
                            .attr("transform", `rotate(${rotateDeg}, ${seatX}, ${seatY})`);
                    }
                })
                .on("mouseout", function () {
                    table.selectAll(".hover-table").remove();
                    table.selectAll(".seat-icon").remove();
                    table.selectAll(".table-text").remove();
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 2)
                        .attr("stroke", "none")
                        .attr("stroke-width", 0)
                        .attr("opacity", 0.7);
                });

            let xRange = [minOwnedUsers, maxOwnedUsers], yRange = [0, maxRating];

            function updateChart() {
                const filteredData = data.filter(d =>
                    d.owned_users >= xRange[0] && d.owned_users <= xRange[1] &&
                    d.rating_average >= yRange[0] && d.rating_average <= yRange[1]
                );

                visibleIndices = filteredData.map(d => d.index);
                console.log("Visible Indices:", visibleIndices);

                let updatedCircles = svg.selectAll("circle").data(filteredData, d => d.id)
                    .on("mouseover", function (event, d) {
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("r", 8)
                            .attr("stroke", "black")
                            .attr("stroke-width", 3)
                            .attr("opacity", 1);
                        let tableColor = tableColorScale(d.domains1);

                        table.append("circle")
                            .attr("class", "hover-table")
                            .attr("cx", 250)
                            .attr("cy", 250)
                            .attr("r", 170)
                            .attr("fill", tableColor)
                            .attr("stroke-width", 3)
                            .attr("stroke", "grey");

                        let textGroup = table.append("g")
                            .attr("class", "table-text")
                            .attr("transform", "translate(250, 230)")
                            .attr("text-anchor", "middle")
                            .attr("font-family", "Gill Sans")
                            .attr("font-size", "13px")

                        const words = d.name.split(/\s+/);
                        const firstPart = words.slice(0, 4).join(' ');
                        const rest = words.slice(4).join(' ');
                        textGroup.append("text")
                            .text(firstPart)
                            .attr("y", -60)
                            .attr("font-weight", "bold");
                        textGroup.append("text")
                            .text(rest)
                            .attr("y", -40)
                            .attr("font-weight", "bold");
                        textGroup.append("text")
                            .text(`Year published: ${d.year_published}`)
                            .attr("y", -20);
                        textGroup.append("text")
                            .text(`Players allowed: ${d.min_players} (Min) - ${d.max_players} (Max)`)
                            .attr("y", 0);
                        textGroup.append("text")
                            .text(`Suggested play time: ${d.play_time} min`)
                            .attr("y", 20);
                        textGroup.append("text")
                            .text(`Game Age Limit: ${d.min_age}+`)
                            .attr("y", 40);
                        textGroup.append("text")
                            .text(`Rating for the game: ${d.rating_average}`)
                            .attr("y", 60);
                        textGroup.append("text")
                            .text(`Game Complexity : ${d.complexity_average}`)
                            .attr("y", 80);
                        textGroup.append("text")
                            .text(`Number of people downloaded : ${d.owned_users}`)
                            .attr("y", 100);


                        let centerX = 250;
                        let centerY = 250;
                        let radius = 170;
                        let maxPlayers = parseInt(d["max_players"], 10)
                        let minPlayers = parseInt(d["min_players"], 10)
                        console.log(maxPlayers);

                        for (let i = 0; i < maxPlayers; i++) {
                            let angle = (i / maxPlayers) * 2 * Math.PI;
                            let seatX = centerX + (radius + 40) * Math.cos(angle);
                            let seatY = centerY + (radius + 40) * Math.sin(angle);
                            let rotateDeg = (angle * 180) / Math.PI + 90;

                            let seatSize = maxPlayers > 15 ? 40 : 60;
                            let offset = seatSize / 2;

                            table.append("image")
                                .attr("class", "seat-icon")
                                .attr("xlink:href", "seat_empty.png")
                                .attr("x", seatX - offset)
                                .attr("y", seatY - offset)
                                .attr("width", seatSize)
                                .attr("height", seatSize)
                                .attr("transform", `rotate(${rotateDeg}, ${seatX}, ${seatY})`)
                                .attr("opacity",0.8);
                        }

                        for (let j = 0; j < minPlayers; j++) {
                            let angle = (j / maxPlayers) * 2 * Math.PI;
                            let seatX = centerX + (radius + 40) * Math.cos(angle);
                            let seatY = centerY + (radius + 40) * Math.sin(angle);
                            let rotateDeg = (angle * 180) / Math.PI + 90;

                            let seatSize = maxPlayers > 15 ? 40 : 60;
                            let offset = seatSize / 2;

                            table.append("image")
                                .attr("class", "seat-icon")
                                .attr("xlink:href", "seat_default.png")
                                .attr("x", seatX - offset)
                                .attr("y", seatY - offset)
                                .attr("width", seatSize)
                                .attr("height", seatSize)
                                .attr("transform", `rotate(${rotateDeg}, ${seatX}, ${seatY})`);
                        }
                    })
                    .on("mouseout", function () {
                        table.selectAll(".hover-table").remove();
                        table.selectAll(".seat-icon").remove();
                        table.selectAll(".table-text").remove();
                        d3.select(this)
                            .transition()
                            .duration(200)
                            .attr("r", 2)
                            .attr("stroke", "none")
                            .attr("stroke-width", 0)
                            .attr("opacity", 0.7);
                    });

                updatedCircles.enter()
                    .append("circle")
                    .attr("cx", d => xScale(d.owned_users))
                    .attr("cy", d => yScale(d.rating_average))
                    .attr("r", 2)
                    .attr("fill", d => tableColorScale(d.domains1))
                    .attr("opacity", 0.7)
                    .merge(updatedCircles)
                    .transition().duration(200)
                    .attr("cx", d => xScale(d.owned_users))
                    .attr("cy", d => yScale(d.rating_average))

                updatedCircles.exit().remove();
            }

            const xBrush = d3.brushX()
                .extent([[margin.left, height - margin.bottom + 5], [width - margin.right, height - margin.bottom + 25]])
                .on("brush end", (event) => {
                    if (event.selection) {
                        xRange = [xScale.invert(event.selection[0]), xScale.invert(event.selection[1])];
                    } else {
                        xRange = [0, maxPlayTime];
                    }
                    updateChart();
                });

            const xBrushG = svg.append("g").attr("class", "brush x-brush").call(xBrush);
            const yBrush = d3.brushY()
                .extent([[margin.left - 25, margin.top], [margin.left - 5, height - margin.bottom]])
                .on("brush end", (event) => {
                    if (event.selection) {
                        yRange = [yScale.invert(event.selection[1]), yScale.invert(event.selection[0])];
                    } else {
                        yRange = [0, maxRating];
                    }
                    updateChart();
                });

            const yBrushG = svg.append("g").attr("class", "brush y-brush").call(yBrush);
            xBrushG.call(xBrush.move, [margin.left, width - margin.right]);
            yBrushG.call(yBrush.move, [margin.top, height - margin.bottom]);

            function zoomChart() {
                xScale.domain(xRange);
                yScale.domain(yRange);
                xAxis.transition().duration(500).call(d3.axisBottom(xScale));
                yAxis.transition().duration(500).call(d3.axisLeft(yScale));
                svg.selectAll("circle")
                    .transition().duration(500)
                    .attr("cx", d => xScale(d.owned_users))
                    .attr("cy", d => yScale(d.rating_average));

                xBrushG.call(xBrush.move, [xScale(xRange[0]), xScale(xRange[1])]);
                yBrushG.call(yBrush.move, [yScale(yRange[1]), yScale(yRange[0])]);
            }

            function resetChart() {
                xScale.domain([minOwnedUsers, maxOwnedUsers]);
                yScale.domain([0, maxRating]);
                xRange = [minOwnedUsers, maxOwnedUsers];
                yRange = [0, maxRating];

                xAxis.transition().duration(500).call(d3.axisBottom(xScale));
                yAxis.transition().duration(500).call(d3.axisLeft(yScale));

                updateChart();

                xBrushG.call(xBrush.move, [margin.left, width - margin.right]);
                yBrushG.call(yBrush.move, [margin.top, height - margin.bottom]);
            }

            document.getElementById("zoom-btn").addEventListener("click", zoomChart);
            document.getElementById("reset-btn").addEventListener("click", resetChart);

        }).catch(error => console.log("Error loading data:", error));
    </script>

<script>
    let inputTimeout = null; 

    function controlFromInput(fromSlider, toSlider, fromInput, toInput) {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => {
        let [from, to] = getParsed(fromInput, toInput);
        if (from < fromSlider.min){
            from = fromSlider.min
        }
        if (from > to) { // invalid
            fromSlider.value = to;
            fromInput.value = to;
        } else { // valid
            fromSlider.value = from;
            fromInput.value = from;
        }
        fillSlider(fromSlider, toSlider, '#C6C6C6', '#bef264');
    }, 200);
    }
    
    function controlToInput(fromSlider, toSlider, fromInput, toInput) {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => {
        let [from, to] = getParsed(fromInput, toInput);
        setToggleAccessible(toInput);
        if (to > toSlider.max){
            to = toSlider.max
        }
        if (from <= to) { // valid
            toSlider.value = to;
            toInput.value = to;
        } else { // invalid
            toSlider.value = from;
            toInput.value = from;
        }
        fillSlider(fromSlider, toSlider, '#C6C6C6', '#bef264');
    }, 200);
    }

    function controlFromSlider(fromSlider, toSlider, fromInput) {
        const [from, to] = getParsed(fromSlider, toSlider);
        if (from > to) { // invalid
            fromSlider.value = to;
            fromInput.value = to;
        } else {
            fromInput.value = from;
        }
        fillSlider(fromSlider, toSlider, '#C6C6C6', '#bef264');
        }

    function controlToSlider(fromSlider, toSlider, toInput) {
        const [from, to] = getParsed(fromSlider, toSlider);
        setToggleAccessible(toSlider);
        if (from <= to) { // valid
            toInput.value = to;
        } else {
            toInput.value = from;
            toSlider.value = from;
        }
        fillSlider(fromSlider, toSlider, '#C6C6C6', '#bef264');
    }

    function getParsed(currentFrom, currentTo) {
        const from = parseInt(currentFrom.value, 10);
        const to = parseInt(currentTo.value, 10);
        return [from, to];
    }

    function fillSlider(fromSlider, toSlider, sliderColor, rangeColor) {
        const rangeDistance = toSlider.max - toSlider.min;
        const fromPosition = fromSlider.value - toSlider.min;
        const toPosition = toSlider.value - toSlider.min;
        toSlider.style.background = `linear-gradient(
            to right,
            ${sliderColor} 0%,
            ${sliderColor} ${(fromPosition)/(rangeDistance)*100}%,
            ${rangeColor} ${((fromPosition)/(rangeDistance))*100}%,
            ${rangeColor} ${(toPosition)/(rangeDistance)*100}%, 
            ${sliderColor} ${(toPosition)/(rangeDistance)*100}%, 
            ${sliderColor} 100%)`;
    }

    function setToggleAccessible(currentTarget) {
        const toSlider = document.querySelector('#toSlider');
        if (Number(currentTarget.value) <= 0 ) {
            toSlider.style.zIndex = 2;
        } else {
            toSlider.style.zIndex = 0;
        }
    };

const fromSlider_players = document.querySelector('#fromSlider');
const toSlider_players = document.querySelector('#toSlider');
const fromInput_players = document.querySelector('#fromInput');
const toInput_players = document.querySelector('#toInput');
fillSlider(fromSlider_players, toSlider_players, '#C6C6C6', '#bef264');
setToggleAccessible(toSlider_players);

fromSlider_players.oninput = () => controlFromSlider(fromSlider_players, toSlider_players, fromInput_players);
toSlider_players.oninput = () => controlToSlider(fromSlider_players, toSlider_players, toInput_players);
fromInput_players.oninput = () => controlFromInput(fromSlider_players, toSlider_players, fromInput_players, toInput_players);
toInput_players.oninput = () => controlToInput(fromSlider_players, toSlider_players, fromInput_players, toInput_players);

</script>

</body>

</html>